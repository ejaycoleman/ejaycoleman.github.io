<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>TRPC Clone</title><meta name="next-head-count" content="3"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js"></script><script src="/_next/static/chunks/webpack-87b3a303122f2f0d.js" defer=""></script><script src="/_next/static/chunks/framework-b650b47bbc6adb58.js" defer=""></script><script src="/_next/static/chunks/main-db86fe2e0e5cd339.js" defer=""></script><script src="/_next/static/chunks/pages/_app-4e2074aa4425ce49.js" defer=""></script><script src="/_next/static/chunks/873-de61f35669dd9e8b.js" defer=""></script><script src="/_next/static/chunks/478-c1e73773950a7a39.js" defer=""></script><script src="/_next/static/chunks/610-975efb37ffe3144d.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-577ffa919875ca39.js" defer=""></script><script src="/_next/static/i9aji2R8TCF0On_9Vc96H/_buildManifest.js" defer=""></script><script src="/_next/static/i9aji2R8TCF0On_9Vc96H/_ssgManifest.js" defer=""></script></head><body><div id="__next"><style data-emotion="css-global o6gwfi">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#fff;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#fff;}</style><style data-emotion="css lgim5d">.css-lgim5d{box-sizing:border-box;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;width:100%;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;}.css-lgim5d>.MuiGrid-item{max-width:none;}</style><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-column css-lgim5d" style="min-height:100vh;background-color:#041533;background:radial-gradient(ellipse at right bottom, #1B4662 10%, #041533 50%, #451838 100%)"><style data-emotion="css 1sbgb3z">.css-1sbgb3z{overflow:hidden;padding:24px;margin:24px;max-width:90%;}</style><style data-emotion="css 1y6o9r8">.css-1y6o9r8{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;border-radius:4px;box-shadow:0px 2px 1px -1px rgba(0,0,0,0.2),0px 1px 1px 0px rgba(0,0,0,0.14),0px 1px 3px 0px rgba(0,0,0,0.12);overflow:hidden;padding:24px;margin:24px;max-width:90%;}</style><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation1 MuiCard-root css-1y6o9r8"><style data-emotion="css o3d33y">.css-o3d33y{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;color:rgba(0, 0, 0, 0.6);}</style><nav class="MuiTypography-root MuiTypography-body1 MuiBreadcrumbs-root css-o3d33y"><style data-emotion="css nhb8h9">.css-nhb8h9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0;margin:0;list-style:none;}</style><ol class="MuiBreadcrumbs-ol css-nhb8h9"><li class="MuiBreadcrumbs-li"><a style="color:#3E1B36;text-decoration:none" href="/">ejayc.co.uk</a></li><style data-emotion="css 3mf706">.css-3mf706{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;margin-left:8px;margin-right:8px;}</style><li aria-hidden="true" class="MuiBreadcrumbs-separator css-3mf706">/</li><li class="MuiBreadcrumbs-li"><a style="color:#3E1B36;text-decoration:none" href="/posts">posts</a></li><li aria-hidden="true" class="MuiBreadcrumbs-separator css-3mf706">/</li><li class="MuiBreadcrumbs-li"><style data-emotion="css 9l3uo3">.css-9l3uo3{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}</style><p class="MuiTypography-root MuiTypography-body1 css-9l3uo3">TRPC Clone</p></li></ol></nav><style data-emotion="css faujvq">.css-faujvq{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:16px;}</style><div class="MuiCardHeader-root css-faujvq"><style data-emotion="css 11qjisw">.css-11qjisw{-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;}</style><div class="MuiCardHeader-content css-11qjisw"><style data-emotion="css 1g3izzu">.css-1g3izzu{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1.5rem;line-height:1.334;letter-spacing:0em;display:block;}</style><span class="MuiTypography-root MuiTypography-h5 MuiCardHeader-title css-1g3izzu">TRPC Clone</span><style data-emotion="css 11is3qa">.css-11is3qa{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;color:rgba(0, 0, 0, 0.6);display:block;}</style><span class="MuiTypography-root MuiTypography-body1 MuiCardHeader-subheader css-11is3qa">July	27, 2023</span></div></div><style data-emotion="css 1qw96cp">.css-1qw96cp{padding:16px;}.css-1qw96cp:last-child{padding-bottom:24px;}</style><div class="MuiCardContent-root css-1qw96cp"><article><style data-emotion="css 1qvttsi">.css-1qvttsi{display:block;-webkit-background-size:cover;background-size:cover;background-repeat:no-repeat;-webkit-background-position:center;background-position:center;position:relative;}</style><div class="MuiCardMedia-root css-1qvttsi"><img alt="Cover Image for TRPC Clone" loading="lazy" width="800" height="315" decoding="async" data-nimg="1" style="color:transparent;width:100%;height:auto" src="/assets/blog/trpc-clone/cover.jpg"/></div><h1>tRPC Clone</h1>
<p>For a while, I’ve been interested in the <a href="https://trpc.io/">tRPC</a> library - a TypeScript library that allows types to be defined in the server and referenced in the client. It’s a clever library, offering lots of functionality while still being easy to use. But beneath the surface is a complex implementation, leveraging advanced concepts in typescript to achieve a seamless experience for users. I wanted to take a deep dive into how it worked, and so that’s how this article originated.</p>
<p>To skip into the code, visit it here: <a href="https://github.com/ejaycoleman/tRPClone">https://github.com/ejaycoleman/tRPClone</a>. This post aims to explain the implementation. It’s also kinda WIP, so expect some parts to be poorly written.</p>
<p>While writing this article, I found that tRPC had officially published a blog post on how to implement the tRPC client: <a href="https://trpc.io/blog/tinyrpc-client">https://trpc.io/blog/tinyrpc-client</a>. My post aims to explain both the client and the server (in a less official way).</p>
<h2>What is tRPC?</h2>
<p>The official tRPC repository includes a simple example of how tRPC can be used: <a href="https://github.com/trpc/trpc/tree/main/examples/minimal">https://github.com/trpc/trpc/tree/main/examples/minimal</a>.</p>
<p>In its simplest form, a server could be defined as such:</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-tsx" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">const</span><span> appRouter </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#DD4A68">router</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">{</span><span>
</span><span>  userList</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> publicProcedure</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">query</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">async</span><span> </span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:slategray">// Retrieve users from a datasource, this is an imaginary database</span><span>
</span><span>    </span><span class="token" style="color:#07a">const</span><span> users </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token control-flow" style="color:#07a">await</span><span> db</span><span class="token" style="color:#999">.</span><span class="token property-access">user</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">findMany</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>    </span><span class="token" style="color:slategray">//    ^?</span><span>
</span><span>    </span><span class="token control-flow" style="color:#07a">return</span><span> users</span><span class="token" style="color:#999">;</span><span>
</span><span>  </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">,</span><span>
</span><span>  userById</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> publicProcedure</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">input</span><span class="token" style="color:#999">(</span><span>z</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">string</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">query</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">async</span><span> </span><span class="token" style="color:#999">(</span><span>opts</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#07a">const</span><span> </span><span class="token" style="color:#999">{</span><span> input </span><span class="token" style="color:#999">}</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> opts</span><span class="token" style="color:#999">;</span><span>
</span><span>    </span><span class="token" style="color:slategray">//      ^?</span><span>
</span><span>    </span><span class="token" style="color:slategray">// Retrieve the user with the given ID</span><span>
</span><span>    </span><span class="token" style="color:#07a">const</span><span> user </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token control-flow" style="color:#07a">await</span><span> db</span><span class="token" style="color:#999">.</span><span class="token property-access">user</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">findById</span><span class="token" style="color:#999">(</span><span>input</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>    </span><span class="token control-flow" style="color:#07a">return</span><span> user</span><span class="token" style="color:#999">;</span><span>
</span><span>  </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">,</span><span>
</span><span>  userCreate</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> publicProcedure
</span><span>    </span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">input</span><span class="token" style="color:#999">(</span><span>z</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">object</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">{</span><span> name</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> z</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">string</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span><span>
</span><span>    </span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">mutation</span><span class="token" style="color:#999">(</span><span class="token" style="color:#07a">async</span><span> </span><span class="token" style="color:#999">(</span><span>opts</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>      </span><span class="token" style="color:#07a">const</span><span> </span><span class="token" style="color:#999">{</span><span> input </span><span class="token" style="color:#999">}</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> opts</span><span class="token" style="color:#999">;</span><span>
</span><span>      </span><span class="token" style="color:slategray">//      ^?</span><span>
</span><span>      </span><span class="token" style="color:slategray">// Create a new user in the database</span><span>
</span><span>      </span><span class="token" style="color:#07a">const</span><span> user </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token control-flow" style="color:#07a">await</span><span> db</span><span class="token" style="color:#999">.</span><span class="token property-access">user</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">create</span><span class="token" style="color:#999">(</span><span>input</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>      </span><span class="token" style="color:slategray">//    ^?</span><span>
</span><span>      </span><span class="token control-flow" style="color:#07a">return</span><span> user</span><span class="token" style="color:#999">;</span><span>
</span><span>    </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">,</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span></code></div></pre>
<p>Here are three endpoints: GET userList, GET userByID (with a query parameter), and POST userCreate (with a body). Zod is used to validate that the userById query parameter is a string, and the userCreate body is an object of {name: string}.</p>
<p>The types of the AppRouter can then be leveraged within the frontend like this:</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-tsx" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">const</span><span> trpc </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token generic-function" style="color:#DD4A68">createTRPCProxyClient</span><span class="token generic-function generic" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token generic-function generic maybe-class-name" style="color:#DD4A68">AppRouter</span><span class="token generic-function generic" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">{</span><span>
</span><span>  links</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">[</span><span>
</span><span>    </span><span class="token" style="color:#DD4A68">httpBatchLink</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">{</span><span>
</span><span>      url</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">&quot;http://localhost:3000&quot;</span><span class="token" style="color:#999">,</span><span>
</span><span>    </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">,</span><span>
</span><span>  </span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">,</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span>
<span></span><span class="token" style="color:#07a">async</span><span> </span><span class="token" style="color:#07a">function</span><span> </span><span class="token" style="color:#DD4A68">main</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>  </span><span class="token" style="color:slategray">/**
</span><span class="token" style="color:slategray">   * Inferring types
</span><span class="token" style="color:slategray">   */</span><span>
</span><span>  </span><span class="token" style="color:#07a">const</span><span> users </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token control-flow" style="color:#07a">await</span><span> trpc</span><span class="token" style="color:#999">.</span><span class="token property-access">userList</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">query</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>  </span><span class="token" style="color:slategray">//    ^?</span><span>
</span><span>  </span><span class="token console" style="color:#DD4A68">console</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">log</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&quot;Users:&quot;</span><span class="token" style="color:#999">,</span><span> users</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span>
<span>  </span><span class="token" style="color:#07a">const</span><span> createdUser </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token control-flow" style="color:#07a">await</span><span> trpc</span><span class="token" style="color:#999">.</span><span class="token property-access">userCreate</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">mutate</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">{</span><span> name</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">&quot;sachinraja&quot;</span><span> </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>  </span><span class="token" style="color:slategray">//    ^?</span><span>
</span><span>  </span><span class="token console" style="color:#DD4A68">console</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">log</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&quot;Created user:&quot;</span><span class="token" style="color:#999">,</span><span> createdUser</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span>
<span>  </span><span class="token" style="color:#07a">const</span><span> user </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token control-flow" style="color:#07a">await</span><span> trpc</span><span class="token" style="color:#999">.</span><span class="token property-access">userById</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">query</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&quot;1&quot;</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>  </span><span class="token" style="color:slategray">//    ^?</span><span>
</span><span>  </span><span class="token console" style="color:#DD4A68">console</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">log</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&quot;User 1:&quot;</span><span class="token" style="color:#999">,</span><span> user</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span></code></div></pre>
<p>Here, the types defined in the server are available in the frontend, which means the returned value from userList.query() will preserve this type:</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-tsx" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">const</span><span> users</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>  name</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">string</span><span class="token" style="color:#999">;</span><span>
</span><span>  id</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">string</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">[</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">;</span></code></div></pre>
<p>This code is available on the official tRPC repository here: <a href="https://github.com/trpc/trpc/tree/main/examples/minimal">https://github.com/trpc/trpc/tree/main/examples/minimal</a></p>
<h2>Seems simple… right?</h2>
<p>Let’s break this down into smaller steps. You need to have the ability to define endpoints on the server, with inputs validated by Zod. You then need to be able to use these types in the frontend, having access to the required input type and return type, but using fetch when called in the frontend. How can these types be shared, but used differently in the frontend and backend? And how can this be done dynamically? Read on to understand an approach to achieve this client/server polymorphism, leveraging JavaScript Proxies, type inference, and conditionals</p>
<h2>Server</h2>
<h3>JSON type</h3>
<p>First things first, we’ll define a standard JSON type in typescript so we can use that for our payloads.</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-tsx" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">type</span><span> </span><span class="token maybe-class-name" style="color:#DD4A68">JSONValue</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#690">string</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">|</span><span> </span><span class="token" style="color:#690">number</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">|</span><span> </span><span class="token" style="color:#690">boolean</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">|</span><span> </span><span class="token maybe-class-name">JSONObject</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">|</span><span> </span><span class="token maybe-class-name">JSONArray</span><span class="token" style="color:#999">;</span><span>
</span>
<span></span><span class="token" style="color:#07a">interface</span><span> </span><span class="token maybe-class-name" style="color:#DD4A68">JSONObject</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>  </span><span class="token" style="color:#999">[</span><span>x</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">string</span><span class="token" style="color:#999">]</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token maybe-class-name">JSONValue</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span>
</span>
<span></span><span class="token" style="color:#07a">interface</span><span> </span><span class="token maybe-class-name" style="color:#DD4A68">JSONArray</span><span> </span><span class="token" style="color:#07a">extends</span><span> </span><span class="token known-class-name" style="color:#DD4A68">Array</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token maybe-class-name" style="color:#DD4A68">JSONValue</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> </span><span class="token" style="color:#999">{</span><span class="token" style="color:#999">}</span></code></div></pre>
<h3>Get and Post types</h3>
<p>Easy! Now we’re going to define two types: Get and Post. These will be similar, and will later be used by the client to build a conditional type.</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-tsx" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token module" style="color:#07a">export</span><span> </span><span class="token" style="color:#07a">type</span><span> </span><span class="token maybe-class-name" style="color:#DD4A68">Get</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token maybe-class-name" style="color:#DD4A68">Input</span><span class="token" style="color:#999">,</span><span class="token" style="color:#DD4A68"> </span><span class="token maybe-class-name" style="color:#DD4A68">Response</span><span class="token" style="color:#DD4A68"> </span><span class="token" style="color:#07a">extends</span><span class="token" style="color:#DD4A68"> </span><span class="token known-class-name" style="color:#DD4A68">Promise</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token maybe-class-name" style="color:#DD4A68">JSONValue</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span class="token" style="color:#DD4A68"> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">|</span><span class="token" style="color:#DD4A68"> </span><span class="token maybe-class-name" style="color:#DD4A68">JSONValue</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>  </span><span class="token function-variable" style="color:#DD4A68">callback</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">(</span><span>input</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token maybe-class-name">Input</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token maybe-class-name">Response</span><span class="token" style="color:#999">;</span><span>
</span><span>  type</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">&quot;get&quot;</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span><span>
</span>
<span></span><span class="token module" style="color:#07a">export</span><span> </span><span class="token" style="color:#07a">type</span><span> </span><span class="token maybe-class-name" style="color:#DD4A68">Post</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token maybe-class-name" style="color:#DD4A68">Input</span><span class="token" style="color:#999">,</span><span class="token" style="color:#DD4A68"> </span><span class="token maybe-class-name" style="color:#DD4A68">Response</span><span class="token" style="color:#DD4A68"> </span><span class="token" style="color:#07a">extends</span><span class="token" style="color:#DD4A68"> </span><span class="token known-class-name" style="color:#DD4A68">Promise</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token maybe-class-name" style="color:#DD4A68">JSONValue</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span class="token" style="color:#DD4A68"> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">|</span><span class="token" style="color:#DD4A68"> </span><span class="token maybe-class-name" style="color:#DD4A68">JSONValue</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>  </span><span class="token function-variable" style="color:#DD4A68">callback</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">(</span><span>input</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token maybe-class-name">Input</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token maybe-class-name">Response</span><span class="token" style="color:#999">;</span><span>
</span><span>  type</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">&quot;post&quot;</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span></code></div></pre>
<p>When the Get or Post type is used, generics will be used to define the input and the response. The first generic, Input, will be used to pass an inferred type from Zod which will be used for our validation. The second generic, Response, will be the response in the form of JSON or a promise of JSON.</p>
<p>Because TypeScript is structural, and not nominal, without the <code>type: &quot;get&quot;</code> or <code>type: &quot;post&quot;</code> , Typescript would treat these as the same type. We’ll see later how this type property is used to differentiate the two.</p>
<h3>get and post methods</h3>
<p>Lets now define the method which will be used to define a get endpoint on the server. This will be of type Get, as defined above, with the generics passed in.</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-tsx" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token module" style="color:#07a">export</span><span> </span><span class="token" style="color:#07a">const</span><span> get </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#905">T</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#905">O</span><span> </span><span class="token" style="color:#07a">extends</span><span> </span><span class="token known-class-name" style="color:#DD4A68">Promise</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token maybe-class-name" style="color:#DD4A68">JSONValue</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">|</span><span> </span><span class="token maybe-class-name">JSONValue</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span class="token" style="color:#999">(</span><span>
</span><span>  </span><span class="token function-variable" style="color:#DD4A68">getCallback</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">(</span><span>input</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#905">T</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#905">O</span><span class="token" style="color:#999">,</span><span>
</span><span>  validate</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> z</span><span class="token" style="color:#999">.</span><span class="token property-access maybe-class-name">ZodType</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#690">any</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">any</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">any</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span>
</span><span></span><span class="token" style="color:#999">)</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token maybe-class-name">Get</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#905">T</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#905">O</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>  </span><span class="token control-flow" style="color:#07a">return</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token function-variable" style="color:#DD4A68">callback</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">(</span><span>input</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>      validate</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?.</span><span class="token method property-access" style="color:#DD4A68">parse</span><span class="token" style="color:#999">(</span><span>input</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>      </span><span class="token control-flow" style="color:#07a">return</span><span> </span><span class="token" style="color:#DD4A68">getCallback</span><span class="token" style="color:#999">(</span><span>input</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>    </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">,</span><span>
</span><span>    type</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">&quot;get&quot;</span><span class="token" style="color:#999">,</span><span>
</span><span>  </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span></code></div></pre>
<p>The T and O generics are used to construct the input and output type of the callback respectively. Validate is a Zod type which allows us to apply Zod’s validation on the input before calling the callback with the input. Finally, type is allocated the literal ‘get’ which will help later on when it comes to conditionals.</p>
<p>Post will take a similar form to get, just with the type assigned to ‘post’ instead.</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-tsx" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token module" style="color:#07a">export</span><span> </span><span class="token" style="color:#07a">const</span><span> post </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#905">T</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#905">O</span><span> </span><span class="token" style="color:#07a">extends</span><span> </span><span class="token known-class-name" style="color:#DD4A68">Promise</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token maybe-class-name" style="color:#DD4A68">JSONValue</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">|</span><span> </span><span class="token maybe-class-name">JSONValue</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span class="token" style="color:#999">(</span><span>
</span><span>  </span><span class="token function-variable" style="color:#DD4A68">postCallback</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">(</span><span>input</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#905">T</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#905">O</span><span class="token" style="color:#999">,</span><span>
</span><span>  validate</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> z</span><span class="token" style="color:#999">.</span><span class="token property-access maybe-class-name">ZodType</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#690">any</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">any</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">any</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span>
</span><span></span><span class="token" style="color:#999">)</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token maybe-class-name">Post</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#905">T</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#905">O</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>  </span><span class="token control-flow" style="color:#07a">return</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token function-variable" style="color:#DD4A68">callback</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">(</span><span>input</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>      validate</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?.</span><span class="token method property-access" style="color:#DD4A68">parse</span><span class="token" style="color:#999">(</span><span>input</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>      </span><span class="token control-flow" style="color:#07a">return</span><span> </span><span class="token" style="color:#DD4A68">postCallback</span><span class="token" style="color:#999">(</span><span>input</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>    </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">,</span><span>
</span><span>    type</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">&quot;post&quot;</span><span class="token" style="color:#999">,</span><span>
</span><span>  </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span></code></div></pre>
<h3>Exposing the methods</h3>
<p>So that code written for the server can take advantage of these methods, we’ll construct an object which includes post, get and input.</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-tsx" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token module" style="color:#07a">export</span><span> </span><span class="token" style="color:#07a">const</span><span> t </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>  input</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#905">T</span><span> </span><span class="token" style="color:#07a">extends</span><span> </span><span class="token" style="color:#DD4A68">z</span><span class="token" style="color:#999">.</span><span class="token property-access maybe-class-name">ZodType</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#690">any</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">any</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">any</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;&gt;</span><span class="token" style="color:#999">(</span><span>inputValidation</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#905">T</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#07a">type</span><span> </span><span class="token maybe-class-name" style="color:#DD4A68">InputSchema</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> z</span><span class="token" style="color:#999">.</span><span class="token property-access">infer</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#07a">typeof</span><span> inputValidation</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span class="token" style="color:#999">;</span><span>
</span>
<span>    </span><span class="token control-flow" style="color:#07a">return</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>      get</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">&lt;</span><span class="token" style="color:#DD4A68">T</span><span class="token" style="color:#905"> </span><span class="token" style="color:#690">extends</span><span class="token" style="color:#905"> </span><span class="token" style="color:#690">JSONValue</span><span class="token" style="color:#999">&gt;</span><span class="token plain-text">(i: (input: InputSchema) =&gt; Promise&lt;T&gt; | T) =&gt; </span><span class="token" style="color:#999">{</span><span>
</span><span>        </span><span class="token control-flow" style="color:#07a">return</span><span> </span><span class="token" style="color:#DD4A68">get</span><span class="token" style="color:#999">(</span><span>i</span><span class="token" style="color:#999">,</span><span> inputValidation</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>      </span><span class="token" style="color:#999">}</span><span class="token plain-text">,
</span><span class="token plain-text">      post: </span><span class="token" style="color:#999">&lt;</span><span class="token" style="color:#DD4A68">T</span><span class="token" style="color:#905"> </span><span class="token" style="color:#690">extends</span><span class="token" style="color:#905"> </span><span class="token" style="color:#690">JSONValue</span><span class="token" style="color:#999">&gt;</span><span class="token plain-text">(
</span><span class="token plain-text">        i: (input: InputSchema) =&gt; Promise&lt;T&gt; | T
</span><span class="token plain-text">      ) =&gt; </span><span class="token" style="color:#999">{</span><span>
</span><span>        </span><span class="token control-flow" style="color:#07a">return</span><span> </span><span class="token" style="color:#DD4A68">post</span><span class="token" style="color:#999">(</span><span>i</span><span class="token" style="color:#999">,</span><span> inputValidation</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>      </span><span class="token" style="color:#999">}</span><span class="token plain-text">,
</span><span class="token plain-text">    };
</span><span class="token plain-text">  },
</span><span class="token plain-text">  get: </span><span class="token" style="color:#999">&lt;</span><span class="token" style="color:#DD4A68">T</span><span class="token" style="color:#905"> </span><span class="token" style="color:#690">extends</span><span class="token" style="color:#905"> </span><span class="token" style="color:#690">JSONValue</span><span class="token" style="color:#999">&gt;</span><span class="token plain-text">(getCallback: () =&gt; Promise&lt;T&gt; | T) =&gt;
</span><span class="token plain-text">    get&lt;&quot;no_input&quot;, Promise&lt;T&gt; | T&gt;(getCallback),
</span><span class="token plain-text">  post: </span><span class="token" style="color:#999">&lt;</span><span class="token" style="color:#DD4A68">T</span><span class="token" style="color:#905"> </span><span class="token" style="color:#690">extends</span><span class="token" style="color:#905"> </span><span class="token" style="color:#690">JSONValue</span><span class="token" style="color:#999">&gt;</span><span class="token plain-text">(postCallback: () =&gt; Promise&lt;T&gt; | T) =&gt;
</span><span class="token plain-text">    post&lt;&quot;no_input&quot;, Promise&lt;T&gt; | T&gt;(postCallback),
</span><span class="token plain-text">};</span></code></div></pre>
<p>Post and get simply call their respective functions along with a type literal of ‘not_input’. This is used for the type conditionals leveraged by the client side code which we’ll explore later.</p>
<p>Input is then a wrapper for post and get which takes an input of a ZodType. This allows the type to be extracted with z.infer and used to declare the type of input, and the ZodType to be passed in as a parameter to be validated by post and get.</p>
<h3>listening</h3>
<p>Finally, there needs to be a way for the routes to be declared and for them to start accepting traffic.</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-tsx" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token module" style="color:#07a">export</span><span> </span><span class="token" style="color:#07a">const</span><span> </span><span class="token function-variable" style="color:#DD4A68">createHTTPServer</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">{</span><span>
</span><span>  router</span><span class="token" style="color:#999">,</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>  router</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">{</span><span> </span><span class="token" style="color:#999">[</span><span>key</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">string</span><span class="token" style="color:#999">]</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token maybe-class-name">Get</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#690">any</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">any</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">|</span><span> </span><span class="token maybe-class-name">Post</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#690">any</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">any</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>  </span><span class="token" style="color:#07a">const</span><span> app </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#DD4A68">express</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span>
<span>  app</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">use</span><span class="token" style="color:#999">(</span><span>bodyParser</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">urlencoded</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">{</span><span> extended</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#905">true</span><span> </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>  app</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">use</span><span class="token" style="color:#999">(</span><span>bodyParser</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">json</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span>
<span>  </span><span class="token known-class-name" style="color:#DD4A68">Object</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">entries</span><span class="token" style="color:#999">(</span><span>router</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">map</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">[</span><span>routeName</span><span class="token" style="color:#999">,</span><span> routeFunction</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span>routeFunction</span><span class="token" style="color:#999">.</span><span class="token property-access">type</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">==</span><span> </span><span class="token" style="color:#690">&quot;get&quot;</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>      app</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">get</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&quot;/&quot;</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> routeName</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#07a">async</span><span> </span><span class="token" style="color:#999">(</span><span>req</span><span class="token" style="color:#999">,</span><span> res</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>        </span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span>req</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?.</span><span>query</span><span class="token" style="color:#999">.</span><span class="token property-access">input</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>          </span><span class="token" style="color:#07a">const</span><span> input </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#DD4A68">decodeURIComponent</span><span class="token" style="color:#999">(</span><span>req</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?.</span><span>query</span><span class="token" style="color:#999">.</span><span class="token property-access">input</span><span> </span><span class="token module" style="color:#07a">as</span><span> </span><span class="token" style="color:#690">string</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>          res</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">send</span><span class="token" style="color:#999">(</span><span class="token control-flow" style="color:#07a">await</span><span> routeFunction</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">callback</span><span class="token" style="color:#999">(</span><span class="token known-class-name" style="color:#DD4A68">JSON</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">parse</span><span class="token" style="color:#999">(</span><span>input</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>        </span><span class="token" style="color:#999">}</span><span> </span><span class="token control-flow" style="color:#07a">else</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>          res</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">send</span><span class="token" style="color:#999">(</span><span class="token control-flow" style="color:#07a">await</span><span> routeFunction</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">callback</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>        </span><span class="token" style="color:#999">}</span><span>
</span><span>      </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>      </span><span class="token control-flow" style="color:#07a">return</span><span class="token" style="color:#999">;</span><span>
</span><span>    </span><span class="token" style="color:#999">}</span><span>
</span>
<span>    </span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span>routeFunction</span><span class="token" style="color:#999">.</span><span class="token property-access">type</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">==</span><span> </span><span class="token" style="color:#690">&quot;post&quot;</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>      app</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">post</span><span class="token" style="color:#999">(</span><span class="token" style="color:#690">&quot;/&quot;</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">+</span><span> routeName</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#07a">async</span><span> </span><span class="token" style="color:#999">(</span><span>req</span><span class="token" style="color:#999">,</span><span> res</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>        res</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">send</span><span class="token" style="color:#999">(</span><span class="token control-flow" style="color:#07a">await</span><span> routeFunction</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">callback</span><span class="token" style="color:#999">(</span><span>req</span><span class="token" style="color:#999">.</span><span class="token property-access">body</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>      </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>      </span><span class="token control-flow" style="color:#07a">return</span><span class="token" style="color:#999">;</span><span>
</span><span>    </span><span class="token" style="color:#999">}</span><span>
</span><span>  </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span>
<span>  </span><span class="token control-flow" style="color:#07a">return</span><span> app</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span></code></div></pre>
<p>This is a simple express implementation. It accepts an object, router, which contains the GET and POST requests. For <code>get</code> requests, inputs are communicated through a JSON stringified query parameter: <code>input</code>. This is then passed onto the associated callback if necessary. For <code>post</code> requests, inputs are communicated through the body.</p>
<h2>Client</h2>
<h3>Proxies</h3>
<p>The next stage is to design the library to be used by the client. The client leverages <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy">JavaScript Proxies</a>: these allow the fundamental operators available on objects to be tapped into and redefined. Proxies allow ‘get’ and ‘apply’ operations to be intercepted: the former intercepting property accessors (eg <code>myProxy.getValue</code>), and the latter intercepting function calls on the object (eg <code>myProxy.applyValue()</code>). Proxies can be used recursively to always apply at any depth of property access. This is leveraged in the client library:</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-tsx" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">const</span><span> </span><span class="token function-variable" style="color:#DD4A68">createInnerProxy</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">(</span><span>callback</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> callbackType</span><span class="token" style="color:#999">,</span><span> path</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">any</span><span class="token" style="color:#999">[</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>  </span><span class="token" style="color:#07a">const</span><span> proxy</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">unknown</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#07a">new</span><span> </span><span class="token known-class-name" style="color:#DD4A68">Proxy</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>    </span><span class="token" style="color:#DD4A68">get</span><span class="token" style="color:#999">(</span><span>_obj</span><span class="token" style="color:#999">,</span><span> key</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>      </span><span class="token control-flow" style="color:#07a">return</span><span> </span><span class="token" style="color:#DD4A68">createInnerProxy</span><span class="token" style="color:#999">(</span><span>callback</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#999">[</span><span class="token spread" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">...</span><span>path</span><span class="token" style="color:#999">,</span><span> key</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>    </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">,</span><span>
</span><span>    </span><span class="token" style="color:#DD4A68">apply</span><span class="token" style="color:#999">(</span><span>_1</span><span class="token" style="color:#999">,</span><span> _2</span><span class="token" style="color:#999">,</span><span> args</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>      </span><span class="token control-flow" style="color:#07a">return</span><span> </span><span class="token" style="color:#DD4A68">callback</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">{</span><span>
</span><span>        args</span><span class="token" style="color:#999">,</span><span>
</span><span>        path</span><span class="token" style="color:#999">,</span><span>
</span><span>      </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>    </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">,</span><span>
</span><span>  </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>  </span><span class="token control-flow" style="color:#07a">return</span><span> proxy</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span></code></div></pre>
<p>Here, property accesses initialise a new proxy recursively, and property function calls will apply the callback, along with the path of the object. This enables us to get the data from a call such as <code>myProxy.getOne.getTwo(&#x27;value&#x27;)</code>, where callback would be called with <code>{args: [&#x27;value&#x27;], path: [&#x27;getOne&#x27;, &#x27;getTwo&#x27;]}</code>, which can eventually be used by our library to determine which endpoints to call.</p>
<p>The initial call of createInnerProxy will be called via a function, allowing the types to be defined and initialising path as an empty array:</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-tsx" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">type</span><span> </span><span class="token" style="color:#DD4A68">callbackType</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">{</span><span>
</span><span>  path</span><span class="token" style="color:#999">,</span><span>
</span><span>  args</span><span class="token" style="color:#999">,</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>  path</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">string</span><span class="token" style="color:#999">[</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">;</span><span>
</span><span>  args</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">string</span><span class="token" style="color:#999">[</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token known-class-name" style="color:#DD4A68">Promise</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token maybe-class-name">AxiosResponse</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#690">any</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#690">any</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;&gt;</span><span class="token" style="color:#999">;</span><span>
</span>
<span></span><span class="token" style="color:#07a">const</span><span> </span><span class="token function-variable" style="color:#DD4A68">createRecursiveProxy</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">(</span><span>callback</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> callbackType</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span>
</span><span>  </span><span class="token" style="color:#DD4A68">createInnerProxy</span><span class="token" style="color:#999">(</span><span>callback</span><span class="token" style="color:#999">,</span><span> </span><span class="token" style="color:#999">[</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span></code></div></pre>
<h3>Overwriting types</h3>
<p>The next step is to define the Query and Mutate types so that the function calls and expected response types can be inferred</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-tsx" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">type</span><span> </span><span class="token maybe-class-name" style="color:#DD4A68">Query</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token maybe-class-name" style="color:#DD4A68">Input</span><span class="token" style="color:#999">,</span><span class="token" style="color:#DD4A68"> </span><span class="token maybe-class-name" style="color:#DD4A68">Response</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>  query</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token maybe-class-name">Input</span><span> </span><span class="token" style="color:#07a">extends</span><span> </span><span class="token" style="color:#690">&quot;no_input&quot;</span><span>
</span><span>    </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span> </span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token maybe-class-name">AxiosResponse</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token maybe-class-name">Response</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span>
</span><span>    </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">(</span><span>param</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token maybe-class-name">Input</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token maybe-class-name">AxiosResponse</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token maybe-class-name">Response</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span><span>
</span>
<span></span><span class="token" style="color:#07a">type</span><span> </span><span class="token maybe-class-name" style="color:#DD4A68">Mutate</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token maybe-class-name" style="color:#DD4A68">Input</span><span class="token" style="color:#999">,</span><span class="token" style="color:#DD4A68"> </span><span class="token maybe-class-name" style="color:#DD4A68">Response</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>  mutate</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token maybe-class-name">Input</span><span> </span><span class="token" style="color:#07a">extends</span><span> </span><span class="token" style="color:#690">&quot;no_input&quot;</span><span>
</span><span>    </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span> </span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token maybe-class-name">AxiosResponse</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token maybe-class-name">Response</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span>
</span><span>    </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">(</span><span>param</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token maybe-class-name">Input</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token maybe-class-name">AxiosResponse</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token maybe-class-name">Response</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span><span class="token" style="color:#999">.</span></code></div></pre>
<p>As previously mentioned in the server-side library, the “no_input” generic value is used by the client to differentiate when a callback input is required. The type of this is inferred from the Query or Mutation call, which is wrapped in another type to differentiate Queries from Mutations.</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-tsx" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#07a">type</span><span> </span><span class="token maybe-class-name" style="color:#DD4A68">OverwriteChildren</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#905">T</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>  </span><span class="token" style="color:#999">[</span><span class="token maybe-class-name">PropertyKey</span><span> </span><span class="token" style="color:#07a">in</span><span> </span><span class="token" style="color:#07a">keyof</span><span> </span><span class="token" style="color:#905">T</span><span class="token" style="color:#999">]</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#905">T</span><span class="token" style="color:#999">[</span><span class="token maybe-class-name">PropertyKey</span><span class="token" style="color:#999">]</span><span> </span><span class="token" style="color:#07a">extends</span><span> </span><span class="token maybe-class-name" style="color:#DD4A68">Get</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#DD4A68">
</span><span class="token" style="color:#DD4A68">    </span><span class="token" style="color:#07a">infer</span><span class="token" style="color:#DD4A68"> </span><span class="token maybe-class-name" style="color:#DD4A68">Input</span><span class="token" style="color:#999">,</span><span class="token" style="color:#DD4A68">
</span><span class="token" style="color:#DD4A68">    </span><span class="token" style="color:#07a">infer</span><span class="token" style="color:#DD4A68"> </span><span class="token maybe-class-name" style="color:#DD4A68">Response</span><span class="token" style="color:#DD4A68">
</span><span class="token" style="color:#DD4A68">  </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span>
</span><span>    </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span> </span><span class="token maybe-class-name">Query</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token maybe-class-name">Input</span><span class="token" style="color:#999">,</span><span> </span><span class="token maybe-class-name">Response</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span>
</span><span>    </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#905">T</span><span class="token" style="color:#999">[</span><span class="token maybe-class-name">PropertyKey</span><span class="token" style="color:#999">]</span><span> </span><span class="token" style="color:#07a">extends</span><span> </span><span class="token maybe-class-name" style="color:#DD4A68">Post</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#07a">infer</span><span class="token" style="color:#DD4A68"> </span><span class="token maybe-class-name" style="color:#DD4A68">Input</span><span class="token" style="color:#999">,</span><span class="token" style="color:#DD4A68"> </span><span class="token" style="color:#07a">infer</span><span class="token" style="color:#DD4A68"> </span><span class="token maybe-class-name" style="color:#DD4A68">Response</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span>
</span><span>    </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span> </span><span class="token maybe-class-name">Mutate</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token maybe-class-name">Input</span><span class="token" style="color:#999">,</span><span> </span><span class="token maybe-class-name">Response</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span>
</span><span>    </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">unknown</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span></code></div></pre>
<p>In OverwriteChildren, T will be the type exported in the server, which we know will be a series of either Gets or Posts. Type inference is used to either redefine a Get&lt;Input, Response&gt; as Query&lt;Input, Response&gt; or a Post&lt;Input, Response&gt; as a Mutate&lt;Input, Response&gt;.</p>
<h3>Exposing functionality</h3>
<p>Finally, the function exposed to the client is createTRPCProxy, which takes the type of the server endpoints, allowing them to shape the Query and Mutations available for the client.</p>
<pre><div style="color:black;background:#f5f2f0;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto"><code class="language-tsx" style="color:black;background:none;text-shadow:0 1px white;font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token module" style="color:#07a">export</span><span> </span><span class="token" style="color:#07a">const</span><span> createTRPCProxy </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#905">T</span><span class="token" style="color:#999">,</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>  </span><span class="token control-flow" style="color:#07a">return</span><span> </span><span class="token" style="color:#DD4A68">createRecursiveProxy</span><span class="token" style="color:#999">(</span><span>
</span><span>    </span><span class="token" style="color:#999">(</span><span class="token" style="color:#999">{</span><span> path</span><span class="token" style="color:#999">,</span><span> args </span><span class="token" style="color:#999">}</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#999">{</span><span> path</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">string</span><span class="token" style="color:#999">[</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">;</span><span> args</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">string</span><span class="token" style="color:#999">[</span><span class="token" style="color:#999">]</span><span> </span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">)</span><span> </span><span class="token arrow" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=&gt;</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>      </span><span class="token" style="color:#07a">const</span><span> routeName </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> path</span><span class="token" style="color:#999">[</span><span class="token" style="color:#905">0</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">;</span><span>
</span><span>      </span><span class="token" style="color:#07a">const</span><span> procedureType </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> path</span><span class="token" style="color:#999">[</span><span>path</span><span class="token" style="color:#999">.</span><span class="token property-access">length</span><span> </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">-</span><span> </span><span class="token" style="color:#905">1</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">;</span><span>
</span>
<span>      </span><span class="token control-flow" style="color:#07a">if</span><span> </span><span class="token" style="color:#999">(</span><span>procedureType </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">===</span><span> </span><span class="token" style="color:#690">&quot;query&quot;</span><span class="token" style="color:#999">)</span><span> </span><span class="token" style="color:#999">{</span><span>
</span><span>        </span><span class="token" style="color:#07a">const</span><span> parsedArgs </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">=</span><span> args</span><span class="token" style="color:#999">[</span><span class="token" style="color:#905">0</span><span class="token" style="color:#999">]</span><span>
</span><span>          </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">?</span><span> </span><span class="token template-string template-punctuation" style="color:#690">`</span><span class="token template-string" style="color:#690">?input=</span><span class="token template-string interpolation interpolation-punctuation" style="color:#999">${</span><span class="token template-string interpolation" style="color:#DD4A68">encodeURIComponent</span><span class="token template-string interpolation" style="color:#999">(</span><span class="token template-string interpolation known-class-name" style="color:#DD4A68">JSON</span><span class="token template-string interpolation" style="color:#999">.</span><span class="token template-string interpolation method property-access" style="color:#DD4A68">stringify</span><span class="token template-string interpolation" style="color:#999">(</span><span class="token template-string interpolation">args</span><span class="token template-string interpolation" style="color:#999">[</span><span class="token template-string interpolation" style="color:#905">0</span><span class="token template-string interpolation" style="color:#999">]</span><span class="token template-string interpolation" style="color:#999">)</span><span class="token template-string interpolation" style="color:#999">)</span><span class="token template-string interpolation interpolation-punctuation" style="color:#999">}</span><span class="token template-string template-punctuation" style="color:#690">`</span><span>
</span><span>          </span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">:</span><span> </span><span class="token" style="color:#690">&quot;&quot;</span><span class="token" style="color:#999">;</span><span>
</span>
<span>        </span><span class="token control-flow" style="color:#07a">return</span><span> axios</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">get</span><span class="token" style="color:#999">(</span><span class="token template-string template-punctuation" style="color:#690">`</span><span class="token template-string" style="color:#690">http://localhost:3000/</span><span class="token template-string interpolation interpolation-punctuation" style="color:#999">${</span><span class="token template-string interpolation">routeName</span><span class="token template-string interpolation interpolation-punctuation" style="color:#999">}</span><span class="token template-string interpolation interpolation-punctuation" style="color:#999">${</span><span class="token template-string interpolation">parsedArgs</span><span class="token template-string interpolation interpolation-punctuation" style="color:#999">}</span><span class="token template-string template-punctuation" style="color:#690">`</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>      </span><span class="token" style="color:#999">}</span><span>
</span>
<span>      </span><span class="token control-flow" style="color:#07a">return</span><span> axios</span><span class="token" style="color:#999">.</span><span class="token method property-access" style="color:#DD4A68">post</span><span class="token" style="color:#999">(</span><span class="token template-string template-punctuation" style="color:#690">`</span><span class="token template-string" style="color:#690">http://localhost:3000/</span><span class="token template-string interpolation interpolation-punctuation" style="color:#999">${</span><span class="token template-string interpolation">routeName</span><span class="token template-string interpolation interpolation-punctuation" style="color:#999">}</span><span class="token template-string template-punctuation" style="color:#690">`</span><span class="token" style="color:#999">,</span><span> args</span><span class="token" style="color:#999">[</span><span class="token" style="color:#905">0</span><span class="token" style="color:#999">]</span><span class="token" style="color:#999">)</span><span class="token" style="color:#999">;</span><span>
</span><span>    </span><span class="token" style="color:#999">}</span><span>
</span><span>  </span><span class="token" style="color:#999">)</span><span> </span><span class="token module" style="color:#07a">as</span><span> </span><span class="token maybe-class-name">OverwriteChildren</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&lt;</span><span class="token" style="color:#905">T</span><span class="token" style="color:#9a6e3a;background:hsla(0, 0%, 100%, .5)">&gt;</span><span class="token" style="color:#999">;</span><span>
</span><span></span><span class="token" style="color:#999">}</span><span class="token" style="color:#999">;</span></code></div></pre>
<p>Here we call createRecursiveProxy with the callback which determines how to communicate with the server. Since queries will be called something like this: <code>trpc.userList.query()</code>, if we grab the routeName as the first value of the path (’userList’) and the procedureType as the last value of the path (’query’), we can determine that is get request is required. And likewise for post requests.</p>
<h2>Conclusion</h2>
<p>Hopefully, I’ve been able to explain how, through the use of TypeScript type inference, conditionals, and JavaScript proxies, a basic implementation of tRPC can be achieved. If you haven’t already, take a look at the code here: <a href="https://github.com/ejaycoleman/tRPClone">https://github.com/ejaycoleman/tRPClone</a>, and run both the server and client to see how it works.</p>
<p>My implementation isn’t a direct clone either — there are a lot of parts I’ve missed out on for simplicity and other parts I’ve implemented in different ways. My overall intention is to demonstrate the complexities of tRPC and how they achieve the simplicity it brings to users.</p></article></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"TRPC Clone","date":"2023-07-27T05:35:07.322Z","slug":"trpc-clone","content":"\n# tRPC Clone\n\nFor a while, I’ve been interested in the [tRPC](https://trpc.io/) library - a TypeScript library that allows types to be defined in the server and referenced in the client. It’s a clever library, offering lots of functionality while still being easy to use. But beneath the surface is a complex implementation, leveraging advanced concepts in typescript to achieve a seamless experience for users. I wanted to take a deep dive into how it worked, and so that’s how this article originated.\n\nTo skip into the code, visit it here: https://github.com/ejaycoleman/tRPClone. This post aims to explain the implementation. It’s also kinda WIP, so expect some parts to be poorly written.\n\nWhile writing this article, I found that tRPC had officially published a blog post on how to implement the tRPC client: [https://trpc.io/blog/tinyrpc-client](https://trpc.io/blog/tinyrpc-client). My post aims to explain both the client and the server (in a less official way).\n\n## What is tRPC?\n\nThe official tRPC repository includes a simple example of how tRPC can be used: [https://github.com/trpc/trpc/tree/main/examples/minimal](https://github.com/trpc/trpc/tree/main/examples/minimal).\n\nIn its simplest form, a server could be defined as such:\n\n```tsx\nconst appRouter = router({\n  userList: publicProcedure.query(async () =\u003e {\n    // Retrieve users from a datasource, this is an imaginary database\n    const users = await db.user.findMany();\n    //    ^?\n    return users;\n  }),\n  userById: publicProcedure.input(z.string()).query(async (opts) =\u003e {\n    const { input } = opts;\n    //      ^?\n    // Retrieve the user with the given ID\n    const user = await db.user.findById(input);\n    return user;\n  }),\n  userCreate: publicProcedure\n    .input(z.object({ name: z.string() }))\n    .mutation(async (opts) =\u003e {\n      const { input } = opts;\n      //      ^?\n      // Create a new user in the database\n      const user = await db.user.create(input);\n      //    ^?\n      return user;\n    }),\n});\n```\n\nHere are three endpoints: GET userList, GET userByID (with a query parameter), and POST userCreate (with a body). Zod is used to validate that the userById query parameter is a string, and the userCreate body is an object of {name: string}.\n\nThe types of the AppRouter can then be leveraged within the frontend like this:\n\n```tsx\nconst trpc = createTRPCProxyClient\u003cAppRouter\u003e({\n  links: [\n    httpBatchLink({\n      url: \"http://localhost:3000\",\n    }),\n  ],\n});\n\nasync function main() {\n  /**\n   * Inferring types\n   */\n  const users = await trpc.userList.query();\n  //    ^?\n  console.log(\"Users:\", users);\n\n  const createdUser = await trpc.userCreate.mutate({ name: \"sachinraja\" });\n  //    ^?\n  console.log(\"Created user:\", createdUser);\n\n  const user = await trpc.userById.query(\"1\");\n  //    ^?\n  console.log(\"User 1:\", user);\n}\n```\n\nHere, the types defined in the server are available in the frontend, which means the returned value from userList.query() will preserve this type:\n\n```tsx\nconst users: {\n  name: string;\n  id: string;\n}[];\n```\n\nThis code is available on the official tRPC repository here: [https://github.com/trpc/trpc/tree/main/examples/minimal](https://github.com/trpc/trpc/tree/main/examples/minimal)\n\n## Seems simple… right?\n\nLet’s break this down into smaller steps. You need to have the ability to define endpoints on the server, with inputs validated by Zod. You then need to be able to use these types in the frontend, having access to the required input type and return type, but using fetch when called in the frontend. How can these types be shared, but used differently in the frontend and backend? And how can this be done dynamically? Read on to understand an approach to achieve this client/server polymorphism, leveraging JavaScript Proxies, type inference, and conditionals\n\n## Server\n\n### JSON type\n\nFirst things first, we’ll define a standard JSON type in typescript so we can use that for our payloads.\n\n```tsx\ntype JSONValue = string | number | boolean | JSONObject | JSONArray;\n\ninterface JSONObject {\n  [x: string]: JSONValue;\n}\n\ninterface JSONArray extends Array\u003cJSONValue\u003e {}\n```\n\n### Get and Post types\n\nEasy! Now we’re going to define two types: Get and Post. These will be similar, and will later be used by the client to build a conditional type.\n\n```tsx\nexport type Get\u003cInput, Response extends Promise\u003cJSONValue\u003e | JSONValue\u003e = {\n  callback: (input?: Input) =\u003e Response;\n  type: \"get\";\n};\n\nexport type Post\u003cInput, Response extends Promise\u003cJSONValue\u003e | JSONValue\u003e = {\n  callback: (input?: Input) =\u003e Response;\n  type: \"post\";\n};\n```\n\nWhen the Get or Post type is used, generics will be used to define the input and the response. The first generic, Input, will be used to pass an inferred type from Zod which will be used for our validation. The second generic, Response, will be the response in the form of JSON or a promise of JSON.\n\nBecause TypeScript is structural, and not nominal, without the `type: \"get\"` or `type: \"post\"` , Typescript would treat these as the same type. We’ll see later how this type property is used to differentiate the two.\n\n### get and post methods\n\nLets now define the method which will be used to define a get endpoint on the server. This will be of type Get, as defined above, with the generics passed in.\n\n```tsx\nexport const get = \u003cT, O extends Promise\u003cJSONValue\u003e | JSONValue\u003e(\n  getCallback: (input?: T) =\u003e O,\n  validate?: z.ZodType\u003cany, any, any\u003e\n): Get\u003cT, O\u003e =\u003e {\n  return {\n    callback: (input) =\u003e {\n      validate?.parse(input);\n      return getCallback(input);\n    },\n    type: \"get\",\n  };\n};\n```\n\nThe T and O generics are used to construct the input and output type of the callback respectively. Validate is a Zod type which allows us to apply Zod’s validation on the input before calling the callback with the input. Finally, type is allocated the literal ‘get’ which will help later on when it comes to conditionals.\n\nPost will take a similar form to get, just with the type assigned to ‘post’ instead.\n\n```tsx\nexport const post = \u003cT, O extends Promise\u003cJSONValue\u003e | JSONValue\u003e(\n  postCallback: (input?: T) =\u003e O,\n  validate?: z.ZodType\u003cany, any, any\u003e\n): Post\u003cT, O\u003e =\u003e {\n  return {\n    callback: (input) =\u003e {\n      validate?.parse(input);\n      return postCallback(input);\n    },\n    type: \"post\",\n  };\n};\n```\n\n### Exposing the methods\n\nSo that code written for the server can take advantage of these methods, we’ll construct an object which includes post, get and input.\n\n```tsx\nexport const t = {\n  input: \u003cT extends z.ZodType\u003cany, any, any\u003e\u003e(inputValidation: T) =\u003e {\n    type InputSchema = z.infer\u003ctypeof inputValidation\u003e;\n\n    return {\n      get: \u003cT extends JSONValue\u003e(i: (input: InputSchema) =\u003e Promise\u003cT\u003e | T) =\u003e {\n        return get(i, inputValidation);\n      },\n      post: \u003cT extends JSONValue\u003e(\n        i: (input: InputSchema) =\u003e Promise\u003cT\u003e | T\n      ) =\u003e {\n        return post(i, inputValidation);\n      },\n    };\n  },\n  get: \u003cT extends JSONValue\u003e(getCallback: () =\u003e Promise\u003cT\u003e | T) =\u003e\n    get\u003c\"no_input\", Promise\u003cT\u003e | T\u003e(getCallback),\n  post: \u003cT extends JSONValue\u003e(postCallback: () =\u003e Promise\u003cT\u003e | T) =\u003e\n    post\u003c\"no_input\", Promise\u003cT\u003e | T\u003e(postCallback),\n};\n```\n\nPost and get simply call their respective functions along with a type literal of ‘not_input’. This is used for the type conditionals leveraged by the client side code which we’ll explore later.\n\nInput is then a wrapper for post and get which takes an input of a ZodType. This allows the type to be extracted with z.infer and used to declare the type of input, and the ZodType to be passed in as a parameter to be validated by post and get.\n\n### listening\n\nFinally, there needs to be a way for the routes to be declared and for them to start accepting traffic.\n\n```tsx\nexport const createHTTPServer = ({\n  router,\n}: {\n  router: { [key: string]: Get\u003cany, any\u003e | Post\u003cany, any\u003e };\n}) =\u003e {\n  const app = express();\n\n  app.use(bodyParser.urlencoded({ extended: true }));\n  app.use(bodyParser.json());\n\n  Object.entries(router).map(([routeName, routeFunction]) =\u003e {\n    if (routeFunction.type == \"get\") {\n      app.get(\"/\" + routeName, async (req, res) =\u003e {\n        if (req?.query.input) {\n          const input = decodeURIComponent(req?.query.input as string);\n          res.send(await routeFunction.callback(JSON.parse(input)));\n        } else {\n          res.send(await routeFunction.callback());\n        }\n      });\n      return;\n    }\n\n    if (routeFunction.type == \"post\") {\n      app.post(\"/\" + routeName, async (req, res) =\u003e {\n        res.send(await routeFunction.callback(req.body));\n      });\n      return;\n    }\n  });\n\n  return app;\n};\n```\n\nThis is a simple express implementation. It accepts an object, router, which contains the GET and POST requests. For `get` requests, inputs are communicated through a JSON stringified query parameter: `input`. This is then passed onto the associated callback if necessary. For `post` requests, inputs are communicated through the body.\n\n## Client\n\n### Proxies\n\nThe next stage is to design the library to be used by the client. The client leverages [JavaScript Proxies](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy): these allow the fundamental operators available on objects to be tapped into and redefined. Proxies allow ‘get’ and ‘apply’ operations to be intercepted: the former intercepting property accessors (eg `myProxy.getValue`), and the latter intercepting function calls on the object (eg `myProxy.applyValue()`). Proxies can be used recursively to always apply at any depth of property access. This is leveraged in the client library:\n\n```tsx\nconst createInnerProxy = (callback: callbackType, path: any[]) =\u003e {\n  const proxy: unknown = new Proxy(() =\u003e {}, {\n    get(_obj, key) {\n      return createInnerProxy(callback, [...path, key]);\n    },\n    apply(_1, _2, args) {\n      return callback({\n        args,\n        path,\n      });\n    },\n  });\n  return proxy;\n};\n```\n\nHere, property accesses initialise a new proxy recursively, and property function calls will apply the callback, along with the path of the object. This enables us to get the data from a call such as `myProxy.getOne.getTwo('value')`, where callback would be called with `{args: ['value'], path: ['getOne', 'getTwo']}`, which can eventually be used by our library to determine which endpoints to call.\n\nThe initial call of createInnerProxy will be called via a function, allowing the types to be defined and initialising path as an empty array:\n\n```tsx\ntype callbackType = ({\n  path,\n  args,\n}: {\n  path: string[];\n  args: string[];\n}) =\u003e Promise\u003cAxiosResponse\u003cany, any\u003e\u003e;\n\nconst createRecursiveProxy = (callback: callbackType) =\u003e\n  createInnerProxy(callback, []);\n```\n\n### Overwriting types\n\nThe next step is to define the Query and Mutate types so that the function calls and expected response types can be inferred\n\n```tsx\ntype Query\u003cInput, Response\u003e = {\n  query: Input extends \"no_input\"\n    ? () =\u003e AxiosResponse\u003cResponse\u003e\n    : (param: Input) =\u003e AxiosResponse\u003cResponse\u003e;\n};\n\ntype Mutate\u003cInput, Response\u003e = {\n  mutate: Input extends \"no_input\"\n    ? () =\u003e AxiosResponse\u003cResponse\u003e\n    : (param: Input) =\u003e AxiosResponse\u003cResponse\u003e;\n};.\n```\n\nAs previously mentioned in the server-side library, the “no_input” generic value is used by the client to differentiate when a callback input is required. The type of this is inferred from the Query or Mutation call, which is wrapped in another type to differentiate Queries from Mutations.\n\n```tsx\ntype OverwriteChildren\u003cT\u003e = {\n  [PropertyKey in keyof T]: T[PropertyKey] extends Get\u003c\n    infer Input,\n    infer Response\n  \u003e\n    ? Query\u003cInput, Response\u003e\n    : T[PropertyKey] extends Post\u003cinfer Input, infer Response\u003e\n    ? Mutate\u003cInput, Response\u003e\n    : unknown;\n};\n```\n\nIn OverwriteChildren, T will be the type exported in the server, which we know will be a series of either Gets or Posts. Type inference is used to either redefine a Get\u003cInput, Response\u003e as Query\u003cInput, Response\u003e or a Post\u003cInput, Response\u003e as a Mutate\u003cInput, Response\u003e.\n\n### Exposing functionality\n\nFinally, the function exposed to the client is createTRPCProxy, which takes the type of the server endpoints, allowing them to shape the Query and Mutations available for the client.\n\n```tsx\nexport const createTRPCProxy = \u003cT,\u003e() =\u003e {\n  return createRecursiveProxy(\n    ({ path, args }: { path: string[]; args: string[] }) =\u003e {\n      const routeName = path[0];\n      const procedureType = path[path.length - 1];\n\n      if (procedureType === \"query\") {\n        const parsedArgs = args[0]\n          ? `?input=${encodeURIComponent(JSON.stringify(args[0]))}`\n          : \"\";\n\n        return axios.get(`http://localhost:3000/${routeName}${parsedArgs}`);\n      }\n\n      return axios.post(`http://localhost:3000/${routeName}`, args[0]);\n    }\n  ) as OverwriteChildren\u003cT\u003e;\n};\n```\n\nHere we call createRecursiveProxy with the callback which determines how to communicate with the server. Since queries will be called something like this: `trpc.userList.query()`, if we grab the routeName as the first value of the path (’userList’) and the procedureType as the last value of the path (’query’), we can determine that is get request is required. And likewise for post requests.\n\n## Conclusion\n\nHopefully, I’ve been able to explain how, through the use of TypeScript type inference, conditionals, and JavaScript proxies, a basic implementation of tRPC can be achieved. If you haven’t already, take a look at the code here: [https://github.com/ejaycoleman/tRPClone](https://github.com/ejaycoleman/tRPClone), and run both the server and client to see how it works.\n\nMy implementation isn’t a direct clone either — there are a lot of parts I’ve missed out on for simplicity and other parts I’ve implemented in different ways. My overall intention is to demonstrate the complexities of tRPC and how they achieve the simplicity it brings to users.\n","coverImage":"/assets/blog/trpc-clone/cover.jpg"}},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"trpc-clone"},"buildId":"i9aji2R8TCF0On_9Vc96H","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>